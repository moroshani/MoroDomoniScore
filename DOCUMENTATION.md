# Domino Helper Backend & Data Blueprint (Supabase Edition)

This document describes how the refreshed Domino Helper frontend integrates with Supabase for authentication, persistence, and progressive web app behaviour. It replaces the earlier localStorage mock and JWT-only plan with a concrete Supabase implementation that works with shared hosting.

## 1. Supabase Project Setup

1. Create a new Supabase project and note the **Project URL** and **Anon public key**. Provide them to the frontend through `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` environment variables.
2. Enable **Email/Password** and **Google** providers in the Supabase Auth dashboard. Set the redirect URL to `https://dominohelper.moroshaniofficial.ir/auth/callback` (and `http://localhost:5173/auth/callback` for development).
3. Under **Authentication → Policies**, keep email confirmations enabled so new accounts must verify their inbox before logging in.

## 2. Database Schema

Two tables are required; each row is automatically filtered by the authenticated user via Row Level Security.

### 2.1 `domino_players`

| Column      | Type        | Notes                                   |
|-------------|-------------|-----------------------------------------|
| `id`        | `uuid`      | Primary key. Use `uuid_generate_v4()` default. |
| `user_id`   | `uuid`      | References `auth.users.id`.             |
| `name`      | `text`      | Display name shown in the UI.           |
| `avatar`    | `text`      | Optional emoji or base64 avatar.        |
| `created_at`| `timestamp` | `default now()`.                         |

### 2.2 `domino_nights`

| Column       | Type        | Notes                                                                 |
|--------------|-------------|-----------------------------------------------------------------------|
| `id`         | `uuid`      | Primary key.                                                          |
| `night_id`   | `text`      | Mirrors the `NightRecord.id` generated by the app (timestamp string). |
| `user_id`    | `uuid`      | References `auth.users.id`.                                           |
| `record`     | `jsonb`     | Full JSON payload of the `NightRecord`.                               |
| `created_at` | `timestamp` | `default now()`.                                                       |

> **Why JSON?** Game nights store nested sets, games, and players. Persisting the entire `NightRecord` document avoids complex joins; analytics views can still be created later with `jsonb_to_recordset` if deeper insights are required.

## 3. Row Level Security Policies

Enable RLS on both tables and add these policies:

```sql
-- Only allow authenticated users to read their own rows
create policy "Users can read their data" on public.domino_players
  for select using ( auth.uid() = user_id );
create policy "Users can read their history" on public.domino_nights
  for select using ( auth.uid() = user_id );

-- Allow inserts and updates for the owner
create policy "Upsert players" on public.domino_players
  for insert with check ( auth.uid() = user_id );
create policy "Update players" on public.domino_players
  for update using ( auth.uid() = user_id );

create policy "Upsert nights" on public.domino_nights
  for insert with check ( auth.uid() = user_id );
create policy "Update nights" on public.domino_nights
  for update using ( auth.uid() = user_id );

-- Allow deletions by the owner
create policy "Delete players" on public.domino_players
  for delete using ( auth.uid() = user_id );
create policy "Delete nights" on public.domino_nights
  for delete using ( auth.uid() = user_id );
```

Because the frontend only upserts entire records, we do not require separate `update` statements for `domino_nights`, but the policy is included for completeness.

## 4. Frontend ↔ Supabase Contract

The React app now calls Supabase directly from the browser:

- **Authentication**
  - `supabase.auth.signInWithPassword({ email, password })`
  - `supabase.auth.signUp({ email, password, options: { data: { full_name } } })`
  - `supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo } })`
  - `supabase.auth.onAuthStateChange` keeps React context synchronised.

- **Players**
  - `getPlayers(userId)` → `SELECT id, name, avatar FROM domino_players WHERE user_id = auth.uid() ORDER BY name`.
  - `savePlayers(userId, players[])` → upserts the entire collection (`onConflict: id`).
  - `updatePlayer`, `deletePlayer` map to `UPDATE`/`DELETE` filtered by `user_id` and `id`.

- **History**
  - `getHistory(userId)` → selects `record` JSON ordered by `created_at DESC` and normalises `NightRecord.id` on the client.
  - `saveHistory(userId, nights[])` → upserts multiple rows by `night_id`, always keeping the most recent record first.
  - `clearHistory(userId)` → deletes all rows for that user.

If Supabase credentials are missing, the UI surfaces warnings and disables mutating actions so local development without a backend still works gracefully.

## 5. Environment Variables

Create an `.env` (or `.env.local`) file in the project root:

```
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=public-anon-key
GEMINI_API_KEY=...
```

The build reads `VITE_*` variables at compile time. Shared hosting deployments should inject the same values before running `npm run build`.

## 6. Progressive Web App Behaviour

- `sw.js` provides an offline cache for the shell.
- `lib/pwa.ts` registers the service worker after hydration.
- Update the `manifest.json` icons to include 192px/512px versions for install prompts (existing file already includes them).

The React app is therefore installable as a PWA and ready for mobile usage.

## 7. Future Enhancements

- Replace JSON storage with fully normalised tables if analytics like per-round stats are required.
- Move Gemini API calls to a Supabase Edge Function to hide the API key.
- Add Supabase Realtime channels if simultaneous players need live updates.

With this blueprint the Domino Helper frontend runs entirely from shared hosting while Supabase manages authentication, storage, and secure access control.
